# steemd Startup Process

This document explains the code flow and major operations that occur when the `steemd` node starts.

## Overview

`steemd` is the main daemon program for the Steem blockchain node. The startup process consists of three major phases:

1. **Initialize** - Parse configuration files, register and initialize plugins
2. **Startup** - Open database, start plugins
3. **Exec** - Run event loop and handle signals

## Entry Point: main()

**File**: [programs/steemd/main.cpp](../../programs/steemd/main.cpp)

### Key Steps

#### 1. Set Program Options (lines 68-79)

```cpp
bpo::options_description options;
steem::utilities::set_logging_program_options( options );
options.add_options()
   ("backtrace", bpo::value< string >()->default_value( "yes" ), "Whether to print backtrace on SIGSEGV" );
appbase::app().add_program_options( bpo::options_description(), options );
```

- Sets up logging-related options and backtrace option.
- Accesses the application singleton instance through `appbase::app()`.

#### 2. Register Plugins (line 81)

```cpp
steem::plugins::register_plugins();
```

**File**: [src/base/manifest/include/steem/manifest/plugins.hpp](../../src/base/manifest/include/steem/manifest/plugins.hpp)

- The `register_plugins()` function registers all available plugins with `appbase::application`.
- This function is auto-generated by the build system and includes all plugins from the `src/plugins/` directory.
- Each plugin is registered using `appbase::app().register_plugin<PluginType>()`.

#### 3. Set Application Metadata (lines 83-84)

```cpp
appbase::app().set_version_string( version_string() );
appbase::app().set_app_name( "steemd" );
```

#### 4. Configure Default Plugins (lines 86-91)

```cpp
appbase::app().set_default_plugins<
   steem::plugins::witness::witness_plugin,
   steem::plugins::account_by_key::account_by_key_plugin,
   steem::plugins::account_by_key::account_by_key_api_plugin >();
```

- Specifies plugins that will be enabled by default even if not mentioned in the configuration file.
- These plugins are included as defaults when generating the `config.ini` file.

#### 5. Initialize Required Plugins (lines 94-98)

```cpp
bool initialized = appbase::app().initialize<
      steem::plugins::chain::chain_plugin,
      steem::plugins::p2p::p2p_plugin,
      steem::plugins::webserver::webserver_plugin >
      ( argc, argv );
```

**File**: [src/base/appbase/include/appbase/application.hpp](../../src/base/appbase/include/appbase/application.hpp#L37)

- These are **mandatory plugins that always load** regardless of configuration:
  - `chain_plugin`: Manages blockchain database
  - `p2p_plugin`: Peer-to-peer networking
  - `webserver_plugin`: RPC web server

#### 6. Configure Logging (lines 109-116)

```cpp
fc::optional< fc::logging_config > logging_config =
   steem::utilities::load_logging_config( args, appbase::app().data_dir() );
if( logging_config )
   fc::configure_logging( *logging_config );
```

- Loads and applies logging configuration from `logging.json` if present.

#### 7. Setup Backtrace (lines 118-122)

```cpp
if( args.at( "backtrace" ).as< string >() == "yes" )
{
   fc::print_stacktrace_on_segfault();
   ilog( "Backtrace on segfault is enabled." );
}
```

- Configures stack trace printing on SIGSEGV.

#### 8. Start and Execute Application (lines 124-125)

```cpp
appbase::app().startup();
appbase::app().exec();
```

## appbase::application Initialization Process

**File**: [src/base/appbase/application.cpp](../../src/base/appbase/application.cpp)

### initialize_impl() (lines 93-190)

This function is called from the `initialize<>()` template method and performs the following:

#### 1. Parse Program Options (lines 97-98)

```cpp
set_program_options();
bpo::store( bpo::parse_command_line( argc, argv, my->_app_options ), my->_args );
```

- Collects and parses command-line options from all registered plugins.

#### 2. Check Help and Version (lines 100-109)

- If `--help` or `--version` flags are present, prints information and returns `false`.

#### 3. Configure Data Directory (lines 111-150)

```cpp
bfs::path data_dir;
if( my->_args.count("data-dir") )
{
   data_dir = my->_args["data-dir"].as<bfs::path>();
   // ...
}
else
{
   // Default: $HOME/.steemd or current_directory/.steemd
}
```

- Default data directory is `$HOME/.steemd` (Windows: `%APPDATA%/.steemd`).
- Can be changed using the `--data-dir` option.

#### 4. Load Configuration File (lines 152-164)

```cpp
bfs::path config_file_name = data_dir / "config.ini";
if(!bfs::exists(config_file_name)) {
   write_default_config(config_file_name);
}
bpo::store(bpo::parse_config_file< char >(
   config_file_name.make_preferred().string().c_str(),
   my->_cfg_options, true ), my->_args );
```

- Creates `config.ini` with default settings if it doesn't exist.
- Parses the configuration file to load options.

#### 5. Initialize Plugins (lines 166-179)

```cpp
if(my->_args.count("plugin") > 0)
{
   auto plugins = my->_args.at("plugin").as<std::vector<std::string>>();
   for(auto& arg : plugins)
      get_plugin(name).initialize(my->_args);
}
for (const auto& plugin : autostart_plugins)
   if (plugin != nullptr && plugin->get_state() == abstract_plugin::registered)
      plugin->initialize(my->_args);
```

- Initializes plugins specified in `config.ini`.
- Initializes required plugins passed as template arguments to `initialize<>`.

**Plugin Initialization Order**:
1. Dependency plugins are initialized first (recursively)
2. `plugin_initialize()` method is called
3. Plugin is added to the initialized plugins list

**File**: [src/base/appbase/include/appbase/application.hpp](../../src/base/appbase/include/appbase/application.hpp#L153-165)

### startup() (lines 36-39)

```cpp
void application::startup() {
   for (const auto& plugin : initialized_plugins)
      plugin->startup();
}
```

- Calls the `startup()` method of all initialized plugins in order.
- Each plugin starts after its dependency plugins have started.

### exec() (lines 210-231)

```cpp
void application::exec() {
   signal(SIGPIPE, SIG_IGN);

   std::shared_ptr<boost::asio::signal_set> sigint_set(
      new boost::asio::signal_set(*io_serv, SIGINT));
   sigint_set->async_wait([sigint_set,this](...) {
     quit();
     sigint_set->cancel();
   });

   std::shared_ptr<boost::asio::signal_set> sigterm_set(
      new boost::asio::signal_set(*io_serv, SIGTERM));
   sigterm_set->async_wait([sigterm_set,this](...) {
     quit();
     sigterm_set->cancel();
   });

   io_serv->run();

   shutdown();
}
```

- Registers signal handlers for SIGINT (Ctrl+C) and SIGTERM.
- Runs the Boost.Asio I/O service event loop.
- When a shutdown signal is received, stops the I/O service and calls `shutdown()`.

## Major Plugin Initialization and Startup

### 1. chain_plugin

**File**: [src/plugins/chain/chain_plugin.cpp](../../src/plugins/chain/chain_plugin.cpp)

#### plugin_initialize() (lines 323-379)

Parses and stores configuration options:

- `shared-file-dir`: Location of blockchain shared memory files (default: `blockchain`)
- `shared-file-size`: Size of shared memory file (default: 24GB, recommended 200GB for full nodes)
- `replay-blockchain`: Clear chain database and replay all blocks
- `resync-blockchain`: Clear both chain database and block log
- `checkpoint`: Configure checkpoint blocks
- `flush-state-interval`: Block interval for flushing shared memory changes to disk

#### plugin_startup() (lines 383-528)

Initializes and starts the blockchain database:

**1. Configure Database Open Arguments (lines 426-435)**

```cpp
database::open_args db_open_args;
db_open_args.data_dir = app().data_dir() / "blockchain";
db_open_args.shared_mem_dir = my->shared_memory_dir;
db_open_args.initial_supply = STEEM_INIT_SUPPLY;
db_open_args.shared_file_size = my->shared_memory_size;
db_open_args.shared_file_full_threshold = my->shared_file_full_threshold;
db_open_args.shared_file_scale_rate = my->shared_file_scale_rate;
db_open_args.do_validate_invariants = my->validate_invariants;
```

**2. Replay or Normal Open (lines 470-522)**

```cpp
if(my->replay)
{
   ilog("Replaying blockchain on user request.");
   last_block_number = my->db.reindex( db_open_args );
}
else
{
   try {
      my->db.open( db_open_args );
   }
   catch( const fc::exception& e ) {
      wlog("Error opening database, attempting to replay blockchain.");
      my->db.reindex( db_open_args );
   }
}
```

- If `--replay-blockchain` flag is present, replays all blocks from the block log.
- Automatically attempts replay if normal open fails.

**3. Start Write Processing Thread (line 527)**

```cpp
my->start_write_processing();
```

- Processes block and transaction write operations in a separate thread.
- See [chain_plugin.cpp:197-268](../../src/plugins/chain/chain_plugin.cpp#L197-268)

### 2. p2p_plugin

**File**: [src/plugins/p2p/p2p_plugin.cpp](../../src/plugins/p2p/p2p_plugin.cpp)

Manages the P2P network layer:

**plugin_initialize()**:
- Configure seed nodes
- Set P2P endpoint
- Set maximum connection count

**plugin_startup()**:
- Initialize Graphene network node
- Start peer connections
- Begin block and transaction synchronization

Key settings:
- `p2p-endpoint`: Endpoint for other peers to connect (e.g., `0.0.0.0:2001`)
- `p2p-seed-node`: Initial seed nodes to connect to
- `p2p-max-connections`: Maximum number of peer connections

### 3. webserver_plugin

**File**: [src/plugins/webserver/webserver_plugin.cpp](../../src/plugins/webserver/webserver_plugin.cpp)

Provides HTTP/WebSocket RPC server:

**plugin_initialize()**:
- Configure HTTP and WebSocket endpoints
- Set CORS configuration

**plugin_startup()**:
- Start HTTP server
- Start WebSocket server
- Register API handlers

Key settings:
- `webserver-http-endpoint`: HTTP RPC endpoint (e.g., `127.0.0.1:8090`)
- `webserver-ws-endpoint`: WebSocket RPC endpoint (e.g., `127.0.0.1:8091`)
- `rpc-endpoint`: Legacy setting (same as webserver-http-endpoint)

## Plugin Lifecycle and Dependencies

### Plugin States

**File**: [src/base/appbase/include/appbase/plugin.hpp](../../src/base/appbase/include/appbase/plugin.hpp)

Each plugin has the following states:

1. **registered**: Plugin is registered but not yet initialized
2. **initialized**: `plugin_initialize()` has been called
3. **started**: `plugin_startup()` has been called
4. **stopped**: `plugin_shutdown()` has been called

### Dependency Handling

Plugins can depend on other plugins. Dependencies are declared as follows:

```cpp
class my_plugin : public appbase::plugin< my_plugin >
{
   // Override plugin_for_each_dependency to declare dependencies
   template< typename Lambda >
   void plugin_for_each_dependency( Lambda&& l )
   {
      l( app().get_plugin< chain_plugin >() );
      l( app().get_plugin< p2p_plugin >() );
   }
};
```

**Initialization Order Guarantee**:
- When a plugin initializes, all dependency plugins are initialized first (recursively).
- When a plugin starts, all dependency plugins are started first.
- When plugins shutdown, they shutdown in **reverse order**.

## Shutdown Process

### shutdown() (lines 192-204)

```cpp
void application::shutdown() {
   for(auto ritr = running_plugins.rbegin();
       ritr != running_plugins.rend(); ++ritr) {
      (*ritr)->shutdown();
   }
   for(auto ritr = running_plugins.rbegin();
       ritr != running_plugins.rend(); ++ritr) {
      plugins.erase((*ritr)->get_name());
   }
   running_plugins.clear();
   initialized_plugins.clear();
   plugins.clear();
}
```

- Shuts down plugins in **reverse order** of startup.
- Calls each plugin's `plugin_shutdown()` method.
- Clears all plugin references.

## Data Directory Structure

The default data directory is `$HOME/.steemd` with the following structure:

```
.steemd/
├── config.ini              # Configuration file
├── logging.json            # Logging configuration (optional)
├── blockchain/             # Blockchain data
│   ├── block_log           # Immutable block log
│   ├── block_log.index     # Block log index
│   └── shared_memory.bin   # Shared memory state file (24GB+)
└── p2p/                    # P2P node data (optional)
    └── peers.json          # Peer information
```

## Main Configuration File: config.ini

Auto-generated on first run with the following key sections:

### Plugin Configuration
```ini
plugin = witness account_by_key account_by_key_api
```

### chain_plugin Configuration
```ini
shared-file-dir = blockchain
shared-file-size = 24G
```

### p2p_plugin Configuration
```ini
p2p-endpoint = 0.0.0.0:2001
p2p-seed-node = seed-1.steemit.com:2001
```

### webserver_plugin Configuration
```ini
webserver-http-endpoint = 127.0.0.1:8090
webserver-ws-endpoint = 127.0.0.1:8091
```

## Common Log Messages at Startup

```
------------------------------------------------------

            STARTING STEEM NETWORK

------------------------------------------------------
genesis public key: STM8GC13uCZbP44HzMLV6zPZGwVQ8Nt4Kji8PapsPiNq1BK153XTX
chain id: 0000000000000000000000000000000000000000000000000000000000000000
blockchain version: 0.23.0
------------------------------------------------------
Opening shared memory from /home/user/.steemd/blockchain
Starting chain with shared_file_size: 25769803776 bytes
Started on blockchain with 12345678 blocks
```

## Debugging and Troubleshooting

### Adjust Log Levels

Modify the `logging.json` file to adjust log levels:

```json
{
  "appenders": [{
    "name": "stderr",
    "type": "console",
    "stream": "std_error",
    "level_colors": [{
        "level": "debug",
        "color": "green"
      }]
  }],
  "loggers": [{
    "name": "default",
    "level": "debug",
    "appenders": ["stderr"]
  }]
}
```

### Replay Chain

If the database is corrupted or plugin configuration has changed:

```bash
steemd --replay-blockchain
```

### Full Resync

Start completely fresh from the block log:

```bash
steemd --resync-blockchain
```

## Related Files

- [programs/steemd/main.cpp](../../programs/steemd/main.cpp) - Main entry point
- [src/base/appbase/application.cpp](../../src/base/appbase/application.cpp) - Application framework
- [src/base/appbase/include/appbase/application.hpp](../../src/base/appbase/include/appbase/application.hpp) - Application interface
- [src/plugins/chain/chain_plugin.cpp](../../src/plugins/chain/chain_plugin.cpp) - Chain plugin
- [src/plugins/p2p/p2p_plugin.cpp](../../src/plugins/p2p/p2p_plugin.cpp) - P2P plugin
- [src/plugins/webserver/webserver_plugin.cpp](../../src/plugins/webserver/webserver_plugin.cpp) - Webserver plugin

## Reference Documentation

- [Plugin Development Guide](plugin.md) - Guide for developing plugins
- [Building Guide](../getting-started/building.md) - Build guide
- [Node Types Guide](../operations/node-types-guide.md) - Node types guide
